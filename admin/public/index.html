<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Caddy 路由管理</title>
</head>
<body>
  <h1>路由列表</h1>
  <table id="routeTable" border="1">
    <thead>
      <tr>
        <th>Index</th>
        <th>路径</th>
        <th>目标</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>添加路由</h2>
  <input id="path" placeholder="路径 (例如 /moontv)">
  <input id="target" placeholder="目标 (例如 localhost:3001)">
  <button onclick="addRoute()">添加</button>
  <button onclick="reloadRoutes()">一键重载</button>

  <script>
    async function fetchRoutes() {
      const res = await fetch('/api/routes');
      const routes = await res.json();
      const tbody = document.querySelector('#routeTable tbody');
      tbody.innerHTML = '';
      routes.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx}</td>
          <td>${r.path}</td>
          <td>${r.target}</td>
          <td>${r.status}${r.alive === false ? ' ❌' : ''}</td>
          <td><button onclick="deleteRoute(${idx})">删除</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addRoute() {
      const path = document.getElementById('path').value;
      const target = document.getElementById('target').value;
      if (!path || !target) return alert('请输入路径和目标');

      const res = await fetch('/api/routes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path, target })
      });

      if (res.ok) {
        alert('路由已生效');
        document.getElementById('path').value = '';
        document.getElementById('target').value = '';
        fetchRoutes();
      } else {
        const msg = await res.text();
        alert('添加失败: ' + msg);
      }
    }

    async function deleteRoute(index) {
      if (!confirm('确定删除吗？')) return;
      const res = await fetch(`/api/routes/${index}`, { method: 'DELETE' });
      if (res.ok) {
        alert('已删除');
        fetchRoutes();
      } else {
        const msg = await res.text();
        alert('删除失败: ' + msg);
      }
    }

    async function reloadRoutes() {
      const res = await fetch('/api/reload', { method: 'POST' });
      if (res.ok) {
        alert('已重载');
        fetchRoutes();
      } else {
        const msg = await res.text();
        alert('重载失败: ' + msg);
      }
    }

    fetchRoutes(); // 页面加载时刷新
  </script>
</body>
</html>
